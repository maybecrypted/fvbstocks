<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plants vs Brainrot Stock</title>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    body {
      font-family:'Comfortaa',cursive,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:#0a0a0a; color:#e5e7eb; line-height:1.6; min-height:100vh
    }
    .container { max-width:1400px; margin:0 auto; padding:2rem 1rem }
    .header { text-align:center; margin-bottom:2rem }
    .header-title { font-size:2rem; font-weight:600; color:#fff; margin-bottom:1rem; opacity:0; animation:fadeInUp .8s ease-out forwards }
    .controls {
      display:flex; justify-content:center; align-items:center; gap:1rem; margin-bottom:2rem;
      font-size:.875rem; color:#9ca3af; opacity:0; animation:fadeInUp .8s ease-out .4s forwards; transition:all .3s ease
    }
    .refresh-btn,.enable-audio-btn,.settings-btn {
      padding:.5rem 1rem; background:#1f1f1f; border:1px solid #2d2d2d;
      border-radius:.5rem; color:#e5e7eb; cursor:pointer;
      transition:all .3s cubic-bezier(.4,0,.2,1); position:relative; overflow:hidden
    }
    .enable-audio-btn { background:#2d4a2d; border-color:#3d5a3d }
    .enable-audio-btn.enabled { background:#1f4a1f; border-color:#2d6a2d; color:#90ee90 }
    .refresh-btn::before,.enable-audio-btn::before,.settings-btn::before {
      content:''; position:absolute; top:50%; left:50%; width:0; height:0;
      background:rgba(255,255,255,.1); transform:translate(-50%,-50%)
    }
    .refresh-btn:hover::before,.enable-audio-btn:hover::before,.settings-btn:hover::before { width:100%; height:100% }
    .refresh-btn:active,.enable-audio-btn:active,.settings-btn:active { transform:translateY(-1px) scale(1.02); transition:all .1s ease }
    .settings-dropdown {
      position:absolute; top:100%; right:0; margin-top:.5rem;
      background:#0f0f0f; border:1px solid #2d2d2d; border-radius:.5rem;
      padding:.75rem; display:none; flex-direction:column; gap:.5rem; min-width:200px; z-index:100
    }
    .settings-dropdown.show { display:flex }
    .settings-option {
      display:flex; align-items:center; justify-content:space-between;
      padding:.5rem; background:#151515; border:1px solid #1f1f1f; border-radius:.375rem;
      cursor:pointer; font-size:.875rem; transition:all .2s ease
    }
    .settings-option:hover { background:#1f1f1f }
    .settings-option input { accent-color:#4ade80; cursor:pointer }
    @keyframes fadeInUp { from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="header-title">Plants vs Brainrots Stock - Live</h1>
      <div class="controls">
        <span id="last-updated">Loading...</span>
        <button class="refresh-btn" onclick="loadStock(true)">Refresh</button>
        <button class="enable-audio-btn" id="enable-audio-btn" onclick="enableAudio()">游댉 Enable Sounds</button>
        <div style="position:relative">
          <button class="settings-btn" onclick="toggleSettings()">丘뙖잺 Settings</button>
          <div class="settings-dropdown" id="settings-dropdown"></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="column">
        <div class="column-header">
          <div class="column-title">Seed Shop</div>
          <div class="column-count" id="seed-count">0 items</div>
        </div>
        <div class="items" id="seed-items">
          <div class="loading">Loading seed stock...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let seedData=null,isShopUpdate=false,audioEnabled=false,serverUpdateTime=null,serverUpdateInterval=5*60*1000
    const emojiToImage={"游꺗":"/images/cactus.png","游꼡":"/images/strawberry.png","游꾺":"/images/pumpkin.png","游꺝":"/images/sunflower.png","游낼":"/images/dragon_fruit.png","游꼕":"/images/eggplant.png","游꼘":"/images/watermelon.png","游꼖":"/images/grape.png","游본":"/images/cocotank.png","游뿺":"/images/carnivorous_plant.png","游볫":"/images/mr_carrot.png","游꼔":"/images/tomatrio.png","游꼓":"/images/shroombino.png"}
    const fruitPriority={"游꺗":1,"游꼡":2,"游꾺":3,"游꺝":4,"游낼":5,"游꼕":6,"游꼘":7,"游본":8,"游뿺":9,"游볫":10,"游꼔":11}
    const itemColors={"游꼘":"#e22bd0","游꼖":"#e22bd0","游본":"#FFD700","游뿺":"#FFD700","游볫":"#C0C0C0","游꼔":"#C0C0C0","游꼓":"#C0C0C0"}
    const defaultImage="/images/default.png"
    const emojiSounds={"游꺗":"/sounds/cactus.mp3","游꼡":"/sounds/strawberry.mp3","游꾺":"/sounds/pumpkin.mp3","游꺝":"/sounds/sunflower.mp3","游낼":"/sounds/dragon_fruit.mp3","游꼕":"/sounds/eggplant.mp3","游꼘":"/sounds/watermelon.mp3","游꼖":"/sounds/grape.mp3","游본":"/sounds/cocotank.mp3","游뿺":"/sounds/carnivorous_plant.mp3","游볫":"/sounds/mr_carrot.mp3","游꼔":"/sounds/tomatrio.mp3","游꼓":"/sounds/shroombino.mp3"}

    let soundSettings={}
    Object.keys(emojiSounds).forEach(e=>soundSettings[e]=true)

    function toggleSettings(){
      const dd=document.getElementById("settings-dropdown")
      dd.classList.toggle("show")
      if(dd.innerHTML===""){
        dd.innerHTML=Object.keys(emojiSounds).map(e=>{
          return `<label class="settings-option"><span>${e}</span><input type="checkbox" data-emoji="${e}" ${soundSettings[e]?"checked":""}></label>`
        }).join("")
        dd.querySelectorAll("input").forEach(cb=>{
          cb.addEventListener("change",ev=>{
            const em=ev.target.dataset.emoji
            soundSettings[em]=ev.target.checked
          })
        })
      }
    }

    function enableAudio(){
      audioEnabled=true
      const b=document.getElementById("enable-audio-btn")
      b.textContent="游댉 Sounds Enabled"
      b.classList.add("enabled")
      const a=new Audio()
      a.src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT"
      a.play().catch(()=>{})
    }

    function playSoundForItem(e){
      if(!audioEnabled) return
      if(!soundSettings[e]) return
      const s=emojiSounds[e]; if(!s) return
      const a=new Audio(s); a.play().catch(err=>console.warn("Sound blocked:",err))
    }

    function getNextShopUpdate(){
      if(serverUpdateTime){
        const now=Date.now(); let next=serverUpdateTime
        while(next<=now) next+=serverUpdateInterval
        return next
      }
      const now=new Date(),m=now.getUTCMinutes(),nm=5*Math.ceil(m/5)
      const next=new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate(),now.getUTCHours(),nm,10,0))
      if(next<=now) next.setUTCMinutes(next.getUTCMinutes()+5)
      return next.getTime()
    }

    function updateCountdown(){
      if(!seedData) return
      const diff=getNextShopUpdate()-Date.now()
      const el=document.getElementById("last-updated")
      const m=Math.floor(diff/60000),s=Math.floor((diff%60000)/1000)
      const lu=new Date(seedData.reportedAt).toLocaleTimeString()
      el.textContent=`Last updated: ${lu} | Next update in: ${m}m ${s}s`
      if(m===0 && s<=5 && s>0) isShopUpdate=true
    }

    async function loadStock(manual=false){
      try{
        const refreshBtn=document.querySelector(".refresh-btn")
        if(isShopUpdate && !manual){
          refreshBtn.classList.add("shop-update")
          setTimeout(()=>{refreshBtn.classList.remove("shop-update");isShopUpdate=false},1500)
        }
        const res=await fetch("/api/seed-shop"),json=await res.json(); seedData=json
        if(json.reportedAt){
          const rt=new Date(json.reportedAt).getTime(),rd=new Date(rt),m=rd.getUTCMinutes(),nm=5*Math.ceil(m/5)
          const next=new Date(Date.UTC(rd.getUTCFullYear(),rd.getUTCMonth(),rd.getUTCDate(),rd.getUTCHours(),nm,10,0))
          if(next<=rd) next.setUTCMinutes(next.getUTCMinutes()+5)
          serverUpdateTime=next.getTime()
        }
        let items=json?.seeds||[],itemsEl=document.getElementById("seed-items"),countEl=document.getElementById("seed-count")
        if(items.length===0){ itemsEl.innerHTML='<div class="empty">No seeds in stock</div>'; countEl.textContent='0 items' }
        else{
          items=items.sort((a,b)=>(fruitPriority[b.emoji]||0)-(fruitPriority[a.emoji]||0))
          itemsEl.innerHTML=items.map(s=>{
            const img=emojiToImage[s.emoji]||defaultImage,color=itemColors[s.emoji]
            return `<div class="item" style="${color?`border:2px solid ${color}; box-shadow:0 0 8px ${color};`:""}">
              <div class="item-icon"><img src="${img}" alt="${s.name}" width="32" height="32"></div>
              <div class="item-details"><div class="item-name">${s.name}</div><div class="item-quantity">Quantity: ${s.qty}</div></div>
            </div>`
          }).join("")
          countEl.textContent=`${items.length} items`
          if(isShopUpdate && !manual) items.forEach(s=>playSoundForItem(s.emoji))
        }
        updateCountdown()
      }catch(err){
        console.error(err)
        document.getElementById("seed-items").innerHTML='<div class="error">Failed to load stock.</div>'
        document.getElementById("last-updated").textContent="Failed to load stock."
      }
    }

    loadStock()
    setInterval(()=>loadStock(false),10000)
    setInterval(updateCountdown,1000)
    document.addEventListener("DOMContentLoaded",()=>{document.getElementById("last-updated").textContent="Loading..."})
  </script>
</body>
</html>
